<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnneadTab InDesign Repather</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #161b22;
            min-height: 100vh;
            border-left: 1px solid #30363d;
            border-right: 1px solid #30363d;
        }

        .header {
            background: #0d1117;
            border-bottom: 1px solid #30363d;
            padding: 24px 32px;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.9em;
            color: #8b949e;
        }

        .content {
            padding: 32px;
        }

        .step {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .step h3 {
            color: #f0f6fc;
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .step p {
            color: #8b949e;
            margin-bottom: 16px;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #f0f6fc;
            font-size: 0.9em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            color: #c9d1d9;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(56, 139, 253, 0.15);
        }

        .form-group input::placeholder {
            color: #484f58;
        }

        .btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-right: 8px;
            margin-bottom: 8px;
            font-family: inherit;
        }

        .btn:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        .btn:active {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }

        .btn:disabled {
            background: #21262d;
            color: #484f58;
            cursor: not-allowed;
            border-color: #21262d;
        }

        .btn-success {
            background: #238636;
            border-color: #238636;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #2ea043;
            border-color: #2ea043;
        }

        .btn-warning {
            background: #da3633;
            border-color: #da3633;
            color: #ffffff;
        }

        .btn-warning:hover {
            background: #f85149;
            border-color: #f85149;
        }

        .status {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
            border: 1px solid;
        }

        .status.success {
            background: rgba(46, 160, 67, 0.1);
            color: #7ee787;
            border-color: rgba(46, 160, 67, 0.4);
        }

        .status.error {
            background: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border-color: rgba(248, 81, 73, 0.4);
        }

        .status.info {
            background: rgba(56, 139, 253, 0.1);
            color: #58a6ff;
            border-color: rgba(56, 139, 253, 0.4);
        }
        
        .status.warning {
            background: rgba(187, 128, 9, 0.1);
            color: #d29922;
            border-color: rgba(187, 128, 9, 0.4);
        }
        
        .error-details {
            background: rgba(248, 81, 73, 0.05);
            border: 1px solid rgba(248, 81, 73, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85em;
            color: #f85149;
        }
        
        .warning-list {
            background: rgba(187, 128, 9, 0.05);
            border: 1px solid rgba(187, 128, 9, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85em;
            color: #d29922;
        }
        
        .warning-list ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .warning-list li {
            margin-bottom: 4px;
        }

        .links-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
            font-size: 0.85em;
        }

        .links-table th, .links-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }

        .links-table th {
            background: #161b22;
            font-weight: 600;
            color: #f0f6fc;
            font-size: 0.9em;
        }

        .links-table tr:hover {
            background: #21262d;
        }

        .links-table td {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            font-family: inherit;
        }

        .status-badge.missing {
            background: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.4);
        }

        .status-badge.linked {
            background: rgba(46, 160, 67, 0.1);
            color: #7ee787;
            border: 1px solid rgba(46, 160, 67, 0.4);
        }

        .status-badge.modified {
            background: rgba(187, 128, 9, 0.1);
            color: #d29922;
            border: 1px solid rgba(187, 128, 9, 0.4);
        }

        .results {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 24px;
            margin-top: 24px;
        }

        .results h4 {
            color: #f0f6fc;
            margin-bottom: 16px;
            font-size: 1.1em;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .result-card {
            background: #0d1117;
            padding: 16px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #30363d;
        }

        .result-card .number {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .result-card.success .number {
            color: #7ee787;
        }

        .result-card.failed .number {
            color: #f85149;
        }

        .result-card.skipped .number {
            color: #d29922;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 2px solid #30363d;
            border-top: 2px solid #58a6ff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        #linksListbox {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 12px;
        }

        #linksListbox option {
            padding: 4px 8px;
        }

        #linksListbox option:hover {
            background: #21262d;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EnneadTab InDesign Repather</h1>
            <p>Repath all links in your InDesign document when folders are renamed</p>
        </div>

        <div class="content">
            <div id="status" class="status info">
                Ready to connect to InDesign
            </div>

                         <!-- Step 1: Connect to InDesign -->
             <div class="step">
                 <h3>Step 1: Connect to InDesign</h3>
                 <p>First, we need to detect and connect to your InDesign application.</p>
                 <button id="detectVersionsBtn" class="btn">Detect InDesign Versions</button>
                 <div id="detectLoading" class="loading">
                     <div class="spinner"></div>
                     <p>Detecting InDesign versions...</p>
                 </div>
                 
                 <div id="versionSelection" class="hidden">
                     <div class="form-group">
                         <label for="indesignVersion">Select InDesign Version:</label>
                         <select id="indesignVersion">
                             <option value="">Loading versions...</option>
                         </select>
                     </div>
                     <button id="connectBtn" class="btn btn-success">Connect to Selected Version</button>
                     <div id="connectLoading" class="loading">
                         <div class="spinner"></div>
                         <p>Connecting to InDesign...</p>
                     </div>
                 </div>
             </div>

            <!-- Step 2: Open Document -->
            <div id="step2" class="step hidden">
                <h3>Step 2: Open InDesign Document</h3>
                <p>Select the InDesign document (.indd file) you want to repath links in.</p>
                <div class="form-group">
                    <label for="documentPath">Document Path:</label>
                    <input type="text" id="documentPath" placeholder="C:\path\to\your\document.indd" readonly>
                    <button id="browseBtn" class="btn">Browse for Document</button>
                </div>
                <button id="openDocBtn" class="btn btn-success" disabled>Open Document</button>
                <div id="openLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Opening document...</p>
                </div>
            </div>

                         <!-- Step 3: View Links -->
             <div id="step3" class="step hidden">
                 <h3>Step 3: Review Current Links</h3>
                 <p>Review the current links in your document before repathing.</p>
                 <button id="refreshLinksBtn" class="btn">Refresh Links</button>
                 
                 <div class="form-group">
                     <label for="linksListbox">All Link Paths:</label>
                     <select id="linksListbox" size="8" style="width: 100%; padding: 8px; border: 2px solid #e1e8ed; border-radius: 8px; font-family: monospace; font-size: 12px;">
                         <option value="">Loading links...</option>
                     </select>
                 </div>
                 
                 <div id="linksContainer"></div>
             </div>

            <!-- Step 4: Repath Links -->
            <div id="step4" class="step hidden">
                <h3>Step 4: Repath Links</h3>
                <p>Enter the old folder path and the new folder path to repath all links.</p>
                <div class="form-group">
                    <label for="oldFolder">Old Folder Path:</label>
                    <input type="text" id="oldFolder" placeholder="C:\old\folder\path">
                </div>
                <div class="form-group">
                    <label for="newFolder">New Folder Path:</label>
                    <input type="text" id="newFolder" placeholder="C:\new\folder\path">
                </div>
                <button id="repathBtn" class="btn btn-warning">Repath All Links</button>
                <div id="repathLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Repathing links...</p>
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="results hidden">
                <h4>Repathing Results</h4>
                <div id="resultsGrid" class="results-grid"></div>
                <div id="resultsDetails"></div>
            </div>
        </div>
    </div>

    <script>
        class InDesignLinkRepather {
            constructor() {
                this.baseUrl = 'http://127.0.0.1:8000';
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkConnection();
            }

            bindEvents() {
                document.getElementById('detectVersionsBtn').addEventListener('click', () => this.detectInDesignVersions());
                document.getElementById('connectBtn').addEventListener('click', () => this.connectToInDesign());
                document.getElementById('browseBtn').addEventListener('click', () => this.browseForDocument());
                document.getElementById('openDocBtn').addEventListener('click', () => this.openDocument());
                document.getElementById('refreshLinksBtn').addEventListener('click', () => this.getLinks());
                document.getElementById('repathBtn').addEventListener('click', () => this.repathLinks());
            }

            async checkConnection() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/status`);
                    if (response.ok) {
                        this.showStatus('Server is running', 'success');
                    } else {
                        this.showStatus('Server not responding', 'error');
                    }
                } catch (error) {
                    this.showStatus('Cannot connect to server. Make sure the Python script is running.', 'error');
                }
            }

            showStatus(message, type = 'info', details = null) {
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = message;
                statusEl.className = `status ${type}`;
                
                // Add error details if provided
                if (details && type === 'error') {
                    statusEl.innerHTML += `<div class="error-details">${details}</div>`;
                }
            }
            
            showWarnings(warnings) {
                if (!warnings || warnings.length === 0) return;
                
                const warningHtml = `
                    <div class="warning-list">
                        <strong>Warnings:</strong>
                        <ul>
                            ${warnings.map(warning => `<li>${warning}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                const statusEl = document.getElementById('status');
                statusEl.innerHTML += warningHtml;
            }

            showLoading(elementId) {
                document.getElementById(elementId).style.display = 'block';
            }

            hideLoading(elementId) {
                document.getElementById(elementId).style.display = 'none';
            }

            showStep(stepId) {
                document.getElementById(stepId).classList.remove('hidden');
            }

            async detectInDesignVersions() {
                this.showLoading('detectLoading');
                try {
                    const response = await fetch(`${this.baseUrl}/api/get_indesign_versions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayInDesignVersions(data.versions);
                        document.getElementById('versionSelection').classList.remove('hidden');
                        
                        let statusMessage = `Found ${data.total_found} InDesign version(s)`;
                        if (data.total_found === 0) {
                            statusMessage = 'No InDesign versions found';
                            this.showStatus(statusMessage, 'warning');
                        } else {
                            this.showStatus(statusMessage, 'success');
                        }
                        
                        // Show warnings if any
                        if (data.warnings) {
                            this.showWarnings(data.warnings);
                        }
                    } else {
                        this.showStatus('Failed to detect InDesign versions', 'error', data.error);
                    }
                } catch (error) {
                    this.showStatus('Failed to detect InDesign versions', 'error', error.message);
                } finally {
                    this.hideLoading('detectLoading');
                }
            }

            displayInDesignVersions(versions) {
                const select = document.getElementById('indesignVersion');
                select.innerHTML = '';
                
                if (versions.length === 0) {
                    select.innerHTML = '<option value="">No InDesign versions found</option>';
                    return;
                }
                
                versions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.registry_path;
                    option.textContent = `${version.version} (${version.path})`;
                    select.appendChild(option);
                });
            }

            async connectToInDesign() {
                const selectedVersion = document.getElementById('indesignVersion').value;
                if (!selectedVersion) {
                    this.showStatus('Please select an InDesign version first', 'error');
                    return;
                }

                this.showLoading('connectLoading');
                try {
                    const response = await fetch(`${this.baseUrl}/api/connect`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ version_path: selectedVersion })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus(data.message, 'success');
                        this.showStep('step2');
                    } else {
                        this.showStatus('Failed to connect to InDesign', 'error', data.error);
                    }
                } catch (error) {
                    this.showStatus('Failed to connect to InDesign', 'error', error.message);
                } finally {
                    this.hideLoading('connectLoading');
                }
            }

            browseForDocument() {
                // Create a file input element
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.indd';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('documentPath').value = file.path || file.name;
                        document.getElementById('openDocBtn').disabled = false;
                    }
                };
                input.click();
            }

            async openDocument() {
                const filePath = document.getElementById('documentPath').value;
                if (!filePath) {
                    this.showStatus('Please select a document first', 'error');
                    return;
                }

                this.showLoading('openLoading');
                try {
                    const response = await fetch(`${this.baseUrl}/api/open_document`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: filePath })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus(data.message, 'success');
                        this.showStep('step3');
                        this.getLinks();
                    } else {
                        this.showStatus('Failed to open document', 'error', data.error);
                    }
                } catch (error) {
                    this.showStatus('Failed to open document', 'error', error.message);
                } finally {
                    this.hideLoading('openLoading');
                }
            }

            async getLinks() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/get_links`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayLinks(data.links);
                        this.showStep('step4');
                    } else {
                        this.showStatus('Failed to get links', 'error', data.error);
                    }
                } catch (error) {
                    this.showStatus('Failed to get links', 'error', error.message);
                }
            }

            displayLinks(links) {
                const container = document.getElementById('linksContainer');
                const listbox = document.getElementById('linksListbox');
                
                if (links.length === 0) {
                    container.innerHTML = '<p>No links found in the document.</p>';
                    listbox.innerHTML = '<option value="">No links found</option>';
                    return;
                }

                // Populate the listbox with link paths
                listbox.innerHTML = '';
                links.forEach(link => {
                    const option = document.createElement('option');
                    option.value = link.file_path;
                    option.textContent = link.file_path;
                    listbox.appendChild(option);
                });

                // Also show the detailed table
                let html = `
                    <table class="links-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Path</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                links.forEach(link => {
                    const statusClass = this.getStatusClass(link.status);
                    const statusText = this.getStatusText(link.status);
                    
                    html += `
                        <tr>
                            <td>${link.name}</td>
                            <td>${link.file_path}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            getStatusClass(status) {
                switch (status) {
                    case 1: return 'linked';
                    case 2: return 'missing';
                    case 3: return 'modified';
                    default: return 'linked';
                }
            }

            getStatusText(status) {
                switch (status) {
                    case 1: return 'Linked';
                    case 2: return 'Missing';
                    case 3: return 'Modified';
                    default: return 'Unknown';
                }
            }

            async repathLinks() {
                const oldFolder = document.getElementById('oldFolder').value.trim();
                const newFolder = document.getElementById('newFolder').value.trim();

                if (!oldFolder || !newFolder) {
                    this.showStatus('Please enter both old and new folder paths', 'error');
                    return;
                }

                this.showLoading('repathLoading');
                try {
                    const response = await fetch(`${this.baseUrl}/api/repath_links`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            old_folder: oldFolder,
                            new_folder: newFolder
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Links repathed successfully!', 'success');
                        this.displayResults(data.results);
                        document.getElementById('results').classList.remove('hidden');
                    } else {
                        this.showStatus('Failed to repath links', 'error', data.error);
                    }
                } catch (error) {
                    this.showStatus('Failed to repath links', 'error', error.message);
                } finally {
                    this.hideLoading('repathLoading');
                }
            }

            displayResults(results) {
                const grid = document.getElementById('resultsGrid');
                const details = document.getElementById('resultsDetails');

                // Display summary
                grid.innerHTML = `
                    <div class="result-card success">
                        <div class="number">${results.success}</div>
                        <div>Successfully Repathed</div>
                    </div>
                    <div class="result-card failed">
                        <div class="number">${results.failed}</div>
                        <div>Failed</div>
                    </div>
                    <div class="result-card skipped">
                        <div class="number">${results.skipped}</div>
                        <div>Skipped</div>
                    </div>
                `;

                // Display details
                if (results.details && results.details.length > 0) {
                    let detailsHtml = '<h4>Details:</h4><table class="links-table">';
                    detailsHtml += '<thead><tr><th>Name</th><th>Old Path</th><th>New Path</th><th>Status</th></tr></thead><tbody>';
                    
                    results.details.forEach(detail => {
                        const statusClass = detail.status === 'success' ? 'success' : 
                                          detail.status === 'file_not_found' ? 'failed' : 'skipped';
                        
                        detailsHtml += `
                            <tr>
                                <td>${detail.name}</td>
                                <td>${detail.old_path}</td>
                                <td>${detail.new_path || 'N/A'}</td>
                                <td><span class="status-badge ${statusClass}">${detail.status}</span></td>
                            </tr>
                        `;
                    });
                    
                    detailsHtml += '</tbody></table>';
                    details.innerHTML = detailsHtml;
                }
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new InDesignLinkRepather();
        });
    </script>
</body>
</html>
